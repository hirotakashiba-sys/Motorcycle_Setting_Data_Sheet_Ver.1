<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorcycle Setting Data Sheet V1.3</title>
    <style>
        :root { --primary: #004d40; --accent: #00bfa5; --bg: #e0f2f1; --panel: #fff; --text: #263238; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; font-size: 14px; line-height: 1.4; }
        * { box-sizing: border-box; }
        .container { max-width: 1200px; margin: auto; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: var(--primary); color: white; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; white-space: nowrap; }
        .header-btns { display: flex; gap: 10px; }
        .header-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; white-space: nowrap; }
        .header-btn:hover { background: rgba(255,255,255,0.3); }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .layout { display: flex; flex-wrap: wrap; gap: 15px; }
        .col-left { flex: 1 1 350px; min-width: 300px; } 
        .col-right { flex: 1.2 1 350px; min-width: 300px; }

        /* ãƒ‘ãƒãƒ« */
        .panel { background: var(--panel); border: 1px solid #b2dfdb; border-radius: 8px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .panel h2 { margin: 0 0 12px 0; font-size: 0.95rem; color: var(--primary); border-bottom: 2px solid #80cbc4; padding-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- ä¿®æ­£ç®‡æ‰€: ãƒ•ã‚©ãƒ¼ãƒ è¡Œ --- */
        .form-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; /* å…¥åŠ›æ¬„åŒå£«ã®ãƒãƒ¼ã‚¸ãƒ³ */
            margin-bottom: 12px; 
            align-items: flex-start; /* ä¸Šæƒãˆã§é«˜ã•é•ã„ã«ã‚ˆã‚‹ã‚ºãƒ¬é˜²æ­¢ */
        }
        
        /* --- ä¿®æ­£ç®‡æ‰€: å€‹åˆ¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ --- */
        .field { 
            /* flex-grow: 1, flex-shrink: 1, basis: auto */
            /* ä¸­èº«ï¼ˆå…¥åŠ›æ¬„ã®å¹…ï¼‰ã«åˆã‚ã›ã¦ã‚³ãƒ³ãƒ†ãƒŠå¹…ã‚’å¤‰ãˆã‚‹è¨­å®š */
            flex: 1 1 auto; 
            min-width: min-content; /* ä¸­èº«ã®æœ€å°å¹…ã¾ã§ã¯ç¸®ã‚€ */
            display: flex; 
            flex-direction: column; 
        }
        /* å¹…åºƒã«ã—ãŸã„é …ç›®ç”¨ */
        .field-w { flex: 2 1 auto; } 
        
        label { 
            display: block; 
            font-size: 0.75rem; 
            color: #00695c; 
            font-weight: 700; 
            margin-bottom: 4px; 
            line-height: 1.2;
            white-space: normal; /* ãƒ©ãƒ™ãƒ«ã®æŠ˜ã‚Šè¿”ã—è¨±å¯ */
            min-height: 1.2em;
        }

        /* --- ä¿®æ­£ç®‡æ‰€: å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        input, select, textarea { 
            /* width: 100% ã‚’ã‚„ã‚ã€min-widthã®ã¿è¨­å®š */
            width: 100%; 
            min-width: 70px; /* æœ€ä½é™ã®ã‚¿ãƒƒãƒ—å¹…ç¢ºä¿ */
            padding: 9px; 
            border: 1px solid #80cbc4; 
            border-radius: 4px; 
            font-size: 0.95rem; 
            height: 40px; 
            transition: border-color 0.2s, width 0.1s; /* å¹…å¤‰æ›´ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã« */
        }
        /* JavaScriptã§å¹…åˆ¶å¾¡ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
        input.auto-width {
            width: auto; /* JSã§pixelæŒ‡å®šã™ã‚‹ãŸã‚autoã«æˆ»ã™ */
            box-sizing: content-box; /* paddingã‚’å«ã¾ãšå¹…è¨ˆç®— */
        }

        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; background: #e0f2f1; }
        input[readonly] { background: #f5f5f5; color: #607d8b; border-color: #e0e0e0; pointer-events: none; }
        textarea { height: auto; width: 100%; }

        /* ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³ç”¨ã‚°ãƒªãƒƒãƒ‰ */
        .sus-grid {
            display: grid;
            /* ç‹­ã„ç”»é¢ã§ã¯1åˆ—ã€åºƒã‘ã‚Œã°è‡ªå‹•ã§åˆ—æ•°å¢— */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        /* ç‰¹åˆ¥ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .base-bg { background-color: #fff; border-color: #b2dfdb; } 
        
        /* è¨ˆç®—çµæœã‚¨ãƒªã‚¢ */
        .calc-box { background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 6px; }
        .res-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px dotted #ccc; padding-bottom: 3px; font-size: 0.9rem; }
        .res-val { font-weight: 800; font-size: 1.15rem; color: #333; white-space: nowrap; }
        .res-diff { font-size: 0.8rem; margin-left: 6px; font-weight: 600; white-space: nowrap; }
        .diff-plus { color: #c62828; } .diff-minus { color: #1565c0; } .diff-zero { color: #90a4ae; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-grp { display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; cursor: pointer; background: #f5f5f5; border: 1px solid #dcdcdc; border-radius: 4px; color: #333; white-space: nowrap; height: 32px; line-height: 1; }
        .btn-weather { background: #e0f7fa; border-color: #006064; color: #006064; font-weight: bold; margin-top: 0; }
        
        .btn-big { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 6px; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .save { background: #004d40; } .save:hover { background: #00332c; }
        .ai { background: #2e7d32; box-shadow: 0 4px 0 #1b5e20; } .ai:active { transform: translateY(4px); box-shadow: none; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 95%; max-width: 600px; margin: 40px auto; padding: 25px; border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; display:flex; flex-direction: column; }
        .prompt-area { width: 100%; height: 200px; font-family: 'Consolas', monospace; font-size: 0.85rem; padding: 12px; background: #fafafa; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap; margin-bottom: 15px; color: #333; }

        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { border-bottom: 1px solid #eee; padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.1s; }
        .history-item:hover { background: #e0f2f1; }
        .history-info { flex: 1; }
        .history-del { background: #ffcdd2; color: #c62828; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight: bold; white-space: nowrap; }
        .data-btn { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px; font-weight: 600; background: #fff; transition: 0.2s; }
        .data-btn:hover { background: #f5f5f5; transform: translateX(2px); }
        .btn-export { border-left: 5px solid #2e7d32; } .btn-import { border-left: 5px solid #1565c0; } .btn-reset { border-left: 5px solid #d32f2f; color: #d32f2f; }

        @media (max-width: 600px) {
            .form-row { gap: 8px; }
            input, select { font-size: 16px; }
            h1 { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ”§ Motorcycle Setting Data Sheet V1.3</h1>
        <div class="header-btns">
            <button class="header-btn" onclick="openHistory()">ğŸ“‚ å±¥æ­´</button>
            <button class="header-btn" onclick="openDataMgr()">âš™ ç®¡ç†</button>
        </div>
    </header>

    <div class="layout">
        <div class="col-left">
            <div class="panel">
                <h2>ğŸ“ å ´æ‰€ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h2>
                <div class="form-row">
                    <div class="field field-w"><label>æ—¥ä»˜</label><input type="date" id="date_input"></div>
                    <div class="field field-w">
                        <label>å ´æ‰€</label>
                        <select id="loc_select" onchange="locChange()"></select>
                        <div class="btn-grp">
                            <button class="btn-sm" onclick="modal('loc_add')">ï¼‹æ–°è¦</button>
                            <button class="btn-sm" id="btn_edit" onclick="modal('loc_edit')" disabled>ç·¨é›†</button>
                            <button class="btn-sm" id="btn_del" onclick="delLoc()" disabled style="color:red;">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
                <div class="form-row" style="align-items: flex-end;">
                     <div class="field" style="flex:0 0 auto;">
                        <button class="btn-sm btn-weather" id="btn_fetch_weather" onclick="fetchWeather()">â˜ï¸ å¤©æ°—å–å¾—</button>
                     </div>
                     <div class="field" style="font-size:0.75rem; color:#666; padding-bottom:5px;">â€»è¦ä½æ‰€ãƒ»é€šä¿¡</div>
                </div>
                <div class="form-row">
                    <div class="field"><label>æ°—æ¸©â„ƒ</label><input type="number" id="temp" value="20"></div>
                    <div class="field"><label>è·¯é¢â„ƒ</label><input type="number" id="road" value="25"></div>
                    <div class="field"><label>æ¹¿åº¦%</label><input type="number" id="humi" value="50"></div>
                    <div class="field"><label>çŠ¶æ³</label><select id="cond"><option>ãƒ‰ãƒ©ã‚¤</option><option>ã‚¦ã‚§ãƒƒãƒˆ</option></select></div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ ãƒ™ãƒ¼ã‚¹è»Šä¸¡ã‚¹ãƒšãƒƒã‚¯ (åŸºæº–å€¤)</h2>
                
                <div class="form-row">
                    <div class="field"><label>åŸºæº–ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼(deg)</label><input type="number" id="b_caster" value="24.0" class="base-bg" oninput="calc()"></div>
                    <div class="field"><label>åŸºæº–WB(mm)</label><input type="number" id="b_wb" value="1410" class="base-bg" oninput="calc()"></div>
                    <div class="field"><label>åŸºæº–åˆ‡è§’(deg)</label><input type="number" id="b_angle" value="30" class="base-bg" oninput="calc()"></div>
                </div>
                
                <div class="form-row" style="background:#e0f2f1; padding:8px; border-radius:4px; border:1px solid #80cbc4;">
                    <div class="field"><label>åŸºæº–ä¸‰åˆOffset(mm)</label><input type="number" id="b_off_tri" value="30" oninput="calc()"></div>
                    <div class="field"><label>åŸºæº–ã‚¢ã‚¯ã‚¹ãƒ«Offset(mm)</label><input type="number" id="b_off_ax" value="0" oninput="calc()"></div>
                    <div class="field"><label>åˆè¨ˆ(mm)</label><input type="text" id="b_off_total" readonly style="font-weight:bold; color:#00695c;"></div>
                </div>

                <div class="form-row">
                    <div class="field field-w"><label>åŸºæº–Fã‚¿ã‚¤ãƒ¤</label><input type="text" id="b_tire" value="120/70-17" class="base-bg" onchange="calc()"></div>
                    <div class="field"><label>åŸºæº–SAé•·(mm)</label><input type="number" id="b_sa" value="550" class="base-bg" oninput="calc()"></div>
                </div>
                <div class="form-row" style="background:#f5f5f5; padding:5px; border-radius:4px;">
                    <div class="field"><label>åŸºæº–ãƒˆãƒ¬ãƒ¼ãƒ« (è‡ªå‹•è¨ˆç®—)</label><input type="text" id="b_trail_calc" readonly style="font-weight:bold;"></div>
                </div>
                
                <div style="margin-top:10px; border-top:1px dashed #bbb; padding-top:10px;">
                    <label style="color:#004d40; font-size:0.8rem;">âš™ åŸºæº–é§†å‹•ç³» (Chain Spec)</label>
                    <div class="form-row">
                        <div class="field">
                            <label>ãƒã‚§ãƒ¼ãƒ³</label>
                            <select id="b_chain_size" onchange="calc()" class="base-bg">
                                <option value="12.70">415/420/428</option>
                                <option value="15.875" selected>520/525/530</option>
                                <option value="19.05">630</option>
                            </select>
                        </div>
                        <div class="field"><label>ãƒªãƒ³ã‚¯æ•°</label><input type="number" id="b_l" value="112" class="base-bg" oninput="calc()"></div>
                    </div>
                    <div class="form-row">
                        <div class="field"><label>Fä¸æ•°</label><input type="number" id="b_f" value="14" class="base-bg" oninput="calc()"></div>
                        <div class="field"><label>Rä¸æ•°</label><input type="number" id="b_r" value="43" class="base-bg" oninput="calc()"></div>
                    </div>
                </div>
            </div>

            <div class="panel" style="border:2px solid #004d40;">
                <h2>ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>
                <div class="calc-box">
                    <div class="res-row">
                        <span>å®ŸåŠ¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼(deg)</span>
                        <div><span class="res-val" id="res_caster">--</span><span class="res-diff" id="diff_caster"></span></div>
                    </div>
                    <div class="res-row">
                        <span>å®ŸåŠ¹ãƒˆãƒ¬ãƒ¼ãƒ«(mm)</span>
                        <div><span class="res-val" id="res_trail">--</span><span class="res-diff" id="diff_trail"></span></div>
                    </div>
                    <div class="res-row">
                        <span>å®ŸåŠ¹WB(mm)</span>
                        <div><span class="res-val" id="res_wb">--</span><span class="res-diff" id="diff_wb"></span></div>
                    </div>
                    <div class="res-row" style="background:rgba(255,255,255,0.5); padding:0 4px; border-radius:4px;">
                        <span>æœ€å°å›è»¢åŠå¾„(m)</span>
                        <div><span class="res-val" id="res_radius">--</span><span class="res-diff" id="diff_radius"></span></div>
                    </div>
                    <div class="res-row" style="border:none; margin-top:5px;">
                        <span>å§¿å‹¢ãƒ”ãƒƒãƒè§’(deg)</span>
                        <span class="res-val" id="res_pitch" style="font-size:1rem; font-weight:normal;">--</span>
                    </div>
                    <hr style="border:0; border-top:1px dashed #bbb; margin:5px 0;">
                    <div class="res-row" style="border:none; margin:0;">
                        <span>äºŒæ¬¡æ¸›é€Ÿæ¯”</span>
                        <div><span class="res-val" id="res_ratio">--</span><span class="res-diff" id="diff_ratio"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-right">
            <div class="panel">
                <h2>ğŸ”§ æœ¬æ—¥ã®ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°</h2>
                
                <div class="form-row">
                    <div class="field field-w"><label>ãƒãƒ³ãƒ‰ãƒ«åˆ‡è§’(deg)</label><input type="number" id="c_angle" value="30" oninput="calc()" placeholder="ç¾åœ¨å€¤"></div>
                </div>
                
                <div class="form-row" style="background:#fff3e0; padding:8px; border-radius:4px; border:1px solid #ffe0b2;">
                    <div class="field"><label>å¤‰æ›´å¾Œ ä¸‰åˆOffset(mm)</label><input type="number" id="c_off_tri" oninput="calc()" placeholder="åŸºæº–ã¨åŒã˜"></div>
                    <div class="field"><label>å¤‰æ›´å¾Œ ã‚¢ã‚¯ã‚¹ãƒ«Offset(mm)</label><input type="number" id="c_off_ax" oninput="calc()" placeholder="åŸºæº–ã¨åŒã˜"></div>
                </div>

                <div class="form-row">
                    <div class="field"><label>çªãå‡ºã—(mm)</label><input type="number" id="p" value="0" oninput="calc()" placeholder="+ã¯å‰ä¸‹ãŒã‚Š"></div>
                    <div class="field"><label>Rè»Šé«˜è£œæ­£(mm)</label><input type="number" id="rh" value="0" oninput="calc()"></div>
                </div>
                
                <label style="margin-top:10px; color:#004d40; font-weight:bold;">ã‚¿ã‚¤ãƒ¤ & é§†å‹•ç³»</label>
                <div class="form-row">
                    <div class="field"><label>ã‚¿ã‚¤ãƒ¤ãƒ¡ãƒ¼ã‚«ãƒ¼</label><input type="text" id="tire_maker" placeholder="Dunlop"></div>
                    <div class="field"><label>ã‚¿ã‚¤ãƒ¤éŠ˜æŸ„</label><input type="text" id="tire_model" placeholder="Q5"></div>
                </div>
                <div class="form-row">
                    <div class="field field-w"><label>Fã‚¿ã‚¤ãƒ¤ã‚µã‚¤ã‚º</label><input type="text" id="c_ft" value="120/70-17" onchange="calc()"></div>
                    <div class="field"><label>Fç©ºæ°—åœ§(kPa)</label><input type="number" id="c_fp" value="200"></div>
                </div>
                <div class="form-row">
                    <div class="field field-w"><label>Rã‚¿ã‚¤ãƒ¤ã‚µã‚¤ã‚º</label><input type="text" id="c_rt" value="180/55-17" onchange="calc()"></div>
                    <div class="field"><label>Rç©ºæ°—åœ§(kPa)</label><input type="number" id="c_rp" value="190"></div>
                </div>

                <div class="form-row" style="margin-top:5px; background:#e0f2f1; padding:8px; border-radius:4px;">
                    <div class="field">
                        <label style="color:#004d40;">ä½¿ç”¨ãƒã‚§ãƒ¼ãƒ³</label>
                        <select id="c_chain_size" onchange="calc()">
                            <option value="12.70">415/420/428</option>
                            <option value="15.875" selected>520/525/530</option>
                            <option value="19.05">630</option>
                        </select>
                    </div>
                    <div class="field"><label style="color:#004d40;">ãƒªãƒ³ã‚¯æ•°</label><input type="number" id="c_l" value="114" oninput="calc()"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>Fä¸æ•°</label><input type="number" id="c_f" value="14" oninput="calc()"></div>
                    <div class="field"><label>Rä¸æ•°</label><input type="number" id="c_r" value="45" oninput="calc()"></div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸŒ€ ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³è©³ç´°ãƒ¡ãƒ¢</h2>
                <div class="form-row">
                    <div class="field-w" style="flex:1;">
                        <label style="border-bottom:1px solid #ccc; color:#e65100;">FRONT</label>
                        <div class="sus-grid">
                            <div><label>ãƒãƒãƒ¬ãƒ¼ãƒˆ(N/mm)</label><input type="text" id="fs" placeholder="0.85"></div>
                            <div><label>æ²¹é¢é«˜(mm)</label><input type="text" id="fo" placeholder="120"></div>
                            <div><label>Comp(ã‚¯ãƒªãƒƒã‚¯)</label><input type="text" id="fc" placeholder="5"></div>
                            <div><label>Reb(ã‚¯ãƒªãƒƒã‚¯)</label><input type="text" id="fr" placeholder="10"></div>
                            <div><label>Pre(mm)</label><input type="text" id="fp" placeholder="0"></div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="field-w" style="flex:1;">
                        <label style="border-bottom:1px solid #ccc; color:#004d40;">REAR</label>
                        <div class="sus-grid">
                            <div><label>ãƒãƒãƒ¬ãƒ¼ãƒˆ(N/mm)</label><input type="text" id="rs" placeholder="10.5"></div>
                            <div><label>ãƒªãƒ³ã‚¯</label><input type="text" id="rl" placeholder="STD"></div>
                            <div><label>Comp(ã‚¯ãƒªãƒƒã‚¯)</label><input type="text" id="rc" placeholder="H2/L10"></div>
                            <div><label>Reb(ã‚¯ãƒªãƒƒã‚¯)</label><input type="text" id="rr" placeholder="12"></div>
                            <div><label>Pre(mm)</label><input type="text" id="rp" placeholder="5mm"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ“ ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ»å‹•ç”»</h2>
                <input type="url" id="v_url" placeholder="YouTube URL (https://...)" style="margin-bottom:8px;">
                <textarea id="impression" rows="4" placeholder="èµ°è¡Œæ„Ÿè¦šã€èª²é¡Œã€è©¦ã—ãŸã“ã¨ãªã©ã‚’å…¥åŠ›..."></textarea>
                
                <button class="btn-big save" onclick="saveToHistory()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (å±¥æ­´ã«è¿½åŠ )</button>
                <button class="btn-big ai" onclick="generatePrompt()">ğŸ¤– AIè§£æã‚’å®Ÿè¡Œ (Promptç”Ÿæˆ)</button>
            </div>
        </div>
    </div>
</div>

<div id="loc_modal" class="modal"><div class="modal-box" style="width:300px;"><h3 id="m_title">å ´æ‰€æƒ…å ±</h3><label>åç§°</label><input type="text" id="m_name" style="margin-bottom:10px;"><label>ä½æ‰€ (å¸‚ç”ºæ‘ã¾ã§å…¥åŠ›)</label><input type="text" id="m_addr" style="margin-bottom:15px;" placeholder="ä¾‹: èŒ¨åŸçœŒã‹ã™ã¿ãŒã†ã‚‰å¸‚"><div style="text-align:right;"><button class="btn-sm" onclick="document.getElementById('loc_modal').style.display='none'">é–‰ã˜ã‚‹</button><button class="btn-sm" onclick="saveLoc()" style="background:#004d40; color:white;">ä¿å­˜</button></div></div></div>
<div id="ai_modal" class="modal"><div class="modal-box"><h3>ğŸ¤– AIã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã®ä¾é ¼æ›¸</h3><textarea id="prompt_output" class="prompt-area"></textarea><div style="text-align:right;"><button class="btn-sm" onclick="copyToClipboard()" style="background:#2e7d32; color:white;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button><button class="btn-sm" onclick="document.getElementById('ai_modal').style.display='none'">é–‰ã˜ã‚‹</button></div></div></div>
<div id="history_modal" class="modal"><div class="modal-box"><h3>ğŸ“‚ ä¿å­˜æ¸ˆã¿å±¥æ­´</h3><div style="max-height:300px; overflow-y:auto; border:1px solid #eee; margin-bottom:10px;"><ul id="history_list" class="history-list"></ul></div><div style="text-align:right;"><button class="btn-sm" onclick="document.getElementById('history_modal').style.display='none'">é–‰ã˜ã‚‹</button></div></div></div>
<div id="data_modal" class="modal"><div class="modal-box"><h3>âš™ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3><button class="data-btn btn-export" onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ (Export)</button><button class="data-btn btn-import" onclick="document.getElementById('file_input').click()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ (Import)</button><input type="file" id="file_input" style="display:none" onchange="importData(this)" accept=".json"><button class="data-btn btn-reset" onclick="resetAllData()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ (Reset)</button><div style="text-align:right; margin-top:10px;"><button class="btn-sm" onclick="document.getElementById('data_modal').style.display='none'">é–‰ã˜ã‚‹</button></div></div></div>

<script>
    // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: å…¥åŠ›å¹…è‡ªå‹•èª¿æ•´ ===
    function adjustInputWidth(el) {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆã®æ­£ç¢ºãªãƒ”ã‚¯ã‚»ãƒ«å¹…ã‚’è¨ˆæ¸¬
        const context = document.createElement('canvas').getContext('2d');
        const style = window.getComputedStyle(el);
        context.font = style.font;
        const text = el.value || el.placeholder || "";
        const width = context.measureText(text).width;
        
        // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã©ã®ä½™è£•åˆ†(+20px)ã‚’è¶³ã—ã¦è¨­å®š
        // æœ€ä½å¹…(70px)ã¯CSSã§ä¿è¨¼
        el.style.width = (width + 25) + 'px';
    }

    function initAutoResize() {
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        inputs.forEach(input => {
            // åˆæœŸåŒ–æ™‚ã«å¹…èª¿æ•´
            adjustInputWidth(input);
            // å…¥åŠ›æ™‚ã«å¹…èª¿æ•´
            input.addEventListener('input', function() {
                adjustInputWidth(this);
            });
        });
    }

    // === 1. å¤©æ°—API ===
    async function fetchWeather() {
        const btn=document.getElementById('btn_fetch_weather');const originalText=btn.innerText;btn.innerText="é€šä¿¡ä¸­...";btn.disabled=true;
        try {
            const loc=locs[document.getElementById('loc_select').value]; const dateStr=document.getElementById('date_input').value;
            if(!loc||!loc.addr)throw new Error("å ´æ‰€ã®ä½æ‰€ãŒå¿…è¦ã§ã™"); if(!dateStr)throw new Error("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
            const gRes=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc.addr)}`);
            const gData=await gRes.json(); if(!gData||gData.length===0)throw new Error("ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            const wRes=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${gData[0].lat}&longitude=${gData[0].lon}&daily=temperature_2m_max,relative_humidity_2m_mean,precipitation_sum&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
            const wData=await wRes.json(); if(!wData.daily)throw new Error("æ°—è±¡ãƒ‡ãƒ¼ã‚¿ãªã—");
            document.getElementById('temp').value=wData.daily.temperature_2m_max[0];
            document.getElementById('humi').value=wData.daily.relative_humidity_2m_mean[0];
            document.getElementById('road').value=(wData.daily.temperature_2m_max[0]+5).toFixed(1);
            document.getElementById('cond').value=(wData.daily.precipitation_sum[0]>0)?"ã‚¦ã‚§ãƒƒãƒˆ":"ãƒ‰ãƒ©ã‚¤";
            alert("å¤©æ°—å–å¾—å®Œäº†");
        } catch(e){alert("ã‚¨ãƒ©ãƒ¼: "+e.message);} finally{btn.innerText=originalText;btn.disabled=false;}
    }

    // === 2. ç‰©ç†æ¼”ç®— ===
    function getRadius(str){try{const m=str.match(/(\d+)\/(\d+)\D+(\d+)/);if(!m)return 300;return((parseInt(m[3])*25.4)+(parseInt(m[1])*(parseInt(m[2])/100)*2))/2;}catch{return 300;}}
    function calculateTrail(deg,rad,off){const r=deg*(Math.PI/180);return(rad*Math.sin(r)-off)/Math.cos(r);}

    function calc(){
        // åŸºæº–å€¤
        const b_caster=parseFloat(document.getElementById('b_caster').value)||24.0;
        const b_wb=parseFloat(document.getElementById('b_wb').value)||1410;
        const off_tri=parseFloat(document.getElementById('b_off_tri').value)||0; 
        const off_ax=parseFloat(document.getElementById('b_off_ax').value)||0;   
        const b_offset=off_tri+off_ax;
        document.getElementById('b_off_total').value=b_offset+"mm";

        const b_f_rad=getRadius(document.getElementById('b_tire').value);
        const b_trail=calculateTrail(b_caster,b_f_rad,b_offset);
        document.getElementById('b_trail_calc').value=b_trail.toFixed(1)+"mm";

        // WBè¨ˆç®— (Chain)
        const b_pitch = parseFloat(document.getElementById('b_chain_size').value) || 15.875;
        const b_l=parseInt(document.getElementById('b_l').value)||112; 
        const b_f=parseInt(document.getElementById('b_f').value)||14; 
        const b_r=parseInt(document.getElementById('b_r').value)||43;
        const b_axle = (b_l*b_pitch - ((b_f+b_r)/2*b_pitch)) / 2;

        const c_pitch = parseFloat(document.getElementById('c_chain_size').value) || 15.875;
        const c_l=parseInt(document.getElementById('c_l').value)||114; 
        const c_f=parseInt(document.getElementById('c_f').value)||14; 
        const c_r=parseInt(document.getElementById('c_r').value)||45;
        const c_axle = (c_l*c_pitch - ((c_f+c_r)/2*c_pitch)) / 2;
        const chain_delta = c_axle - b_axle;

        // ã‚ªãƒ•ã‚»ãƒƒãƒˆå¤‰æ›´ã®WBè£œæ­£
        const c_off_tri_in = document.getElementById('c_off_tri').value;
        const c_off_ax_in = document.getElementById('c_off_ax').value;
        const c_off_tri = (c_off_tri_in==="") ? off_tri : parseFloat(c_off_tri_in);
        const c_off_ax = (c_off_ax_in==="") ? off_ax : parseFloat(c_off_ax_in);
        const c_offset = c_off_tri + c_off_ax;
        
        const offset_delta = c_offset - b_offset;
        const b_rad = b_caster * (Math.PI/180);
        const offset_wb_shift = offset_delta / Math.cos(b_rad); // V14 Fix

        // å®ŸåŠ¹WB
        const cur_wb = b_wb + chain_delta + offset_wb_shift;

        // å§¿å‹¢è¨ˆç®—
        const p=parseFloat(document.getElementById('p').value)||0;
        const rh=parseFloat(document.getElementById('rh').value)||0;
        const c_f_rad=getRadius(document.getElementById('c_ft').value);
        const d_front=(c_f_rad-b_f_rad)-p;
        const pitch_deg=Math.atan2((d_front-rh),cur_wb)*(180/Math.PI);
        
        const cur_caster=b_caster+pitch_deg;
        const cur_trail=calculateTrail(cur_caster,c_f_rad,c_offset);

        // å›è»¢åŠå¾„
        const b_ang=parseFloat(document.getElementById('b_angle').value)||30;
        const c_ang=parseFloat(document.getElementById('c_angle').value)||30;
        const b_radius=b_wb/Math.sin(b_ang*Math.PI/180)/1000;
        const c_radius=cur_wb/Math.sin(c_ang*Math.PI/180)/1000;

        showRes('res_caster','diff_caster',cur_caster,b_caster,2,"Â°");
        showRes('res_trail','diff_trail',cur_trail,b_trail,1,"mm");
        showRes('res_wb','diff_wb',cur_wb,b_wb,0,"mm");
        showRes('res_radius','diff_radius',c_radius,b_radius,2,"m");

        const b_rat=b_r/b_f;const c_rat=c_r/c_f;
        showRes('res_ratio','diff_ratio',c_rat,b_rat,2,"");
        const pt=pitch_deg.toFixed(2)+"Â° "+(pitch_deg<-0.01?"(å‰)":(pitch_deg>0.01?"(å¾Œ)":""));
        document.getElementById('res_pitch').innerText=pt;
    }
    
    function showRes(id,did,c,b,f,u){
        document.getElementById(id).innerText=c.toFixed(f)+u;
        const d=c-b; const e=document.getElementById(did);
        if(Math.abs(d)<0.001){e.innerText="(Â±0)";e.className="res-diff diff-zero";}
        else{e.innerText=`(${d>0?"+":""}${d.toFixed(f)})`;e.className=d>0?"res-diff diff-plus":"res-diff diff-minus";}
    }

    // === 3. ã‚·ã‚¹ãƒ†ãƒ ç³» ===
    function generatePrompt(){
        const d=(id)=>document.getElementById(id).value;
        const t=(id)=>document.getElementById(id).innerText;
        const locName=locs[document.getElementById('loc_select').value]?.name||"æœªé¸æŠ";
        let p=`ãƒ¢ãƒˆã‚¸ãƒ ã‚«ãƒ¼ãƒŠè§£æä¾é ¼:ã‚ãªãŸã¯å„ªç§€ãªãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ãƒãƒ¼ãƒ•ãƒ¡ã‚«ãƒ‹ãƒƒã‚¯ã§ã™ã€‚æç¤ºã•ã‚ŒãŸã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã¨ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚ã‚Œã°å‹•ç”»ï¼‰ã‹ã‚‰è§£æã—ã¦ãã ã•ã„ã€‚ã•ã‚‰ã«é€Ÿãèµ°ã‚‹ç‚ºã«ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã®æ–¹å‘æ€§ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚\næ—¥ä»˜:${d('date_input')} @${locName}\n[ã‚¸ã‚ªãƒ¡ãƒˆãƒª]\nã‚­ãƒ£ã‚¹ã‚¿ãƒ¼(deg):${d('b_caster')}->${t('res_caster')} ${t('diff_caster')}\nãƒˆãƒ¬ãƒ¼ãƒ«(mm):${d('b_trail_calc')}->${t('res_trail')} ${t('diff_trail')}\nWB:${d('b_wb')}->${t('res_wb')} ${t('diff_wb')}\nåˆ‡ã‚Œè§’(deg):${d('b_angle')}->${d('c_angle')}\nåŠå¾„(m):${t('res_radius')} ${t('diff_radius')}\n\n[æ§‹æˆ]\nã‚ªãƒ•ã‚»ãƒƒãƒˆ(mm):${d('b_off_total')}\n\n[è¨­å®š]\nçªãå‡ºã—(mm)${d('p')}, Rè»Šé«˜èª¿æ•´(mm)${d('rh')}\nF${d('c_f')}-R${d('c_r')} (L${d('c_l')})\nã‚¿ã‚¤ãƒ¤ãƒ¡ãƒ¼ã‚«:${d('tire_maker')} ${d('tire_model')}\nã‚¿ã‚¤ãƒ¤ã‚µã‚¤ã‚º F:${d('c_ft')} / R:${d('c_rt')}\nç©ºæ°—åœ§(kPa) F:${d('c_fp')} / R:${d('c_rp')}\n\n[ã‚µã‚¹]\nF:ãƒãƒãƒ¬ãƒ¼ãƒˆ(N/mm)${d('fs')}/æ²¹é¢é«˜(mm)${d('fo')}/Comp(å…¨é–‰ã‹ã‚‰ã®ã‚¯ãƒªãƒƒã‚¯æ•°)${d('fc')}/Reb(å…¨é–‰ã‹ã‚‰ã®ã‚¯ãƒªãƒƒã‚¯æ•°)${d('fr')}/Preload(mm)${d('fp')}\nR:ãƒãƒãƒ¬ãƒ¼ãƒˆ(N/mm)${d('rs')}/ãƒªãƒ³ã‚¯${d('rl')}/Comp(å…¨é–‰ã‹ã‚‰ã®ã‚¯ãƒªãƒƒã‚¯æ•°)${d('rc')}/Reb(å…¨é–‰ã‹ã‚‰ã®ã‚¯ãƒªãƒƒã‚¯æ•°)${d('rr')}/Preload(mm)${d('rp')}\n\n[ã‚¤ãƒ³ãƒ—ãƒ¬]\n${d('impression')}\nURL:${d('v_url')}`;
        document.getElementById('prompt_output').value=p;
        document.getElementById('ai_modal').style.display='block';
    }
    function copyToClipboard(){const t=document.getElementById("prompt_output");t.select();document.execCommand("copy");alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");}
    
    let locs=[{name:"æœªé¸æŠ",addr:""}];
    let editIdx=-1;
    function init(){
        document.getElementById('date_input').valueAsDate=new Date();
        const s=localStorage.getItem('gym_locs_v14'); if(s) locs=JSON.parse(s); 
        else { const old=localStorage.getItem('gym_locs_v13'); if(old) locs=JSON.parse(old); }
        renderLoc();
        const last=localStorage.getItem('gym_autosave_v14');
        if(last) restoreData(JSON.parse(last));
        calc();
        initAutoResize(); // å¹…èª¿æ•´ã®åˆæœŸåŒ–
    }
    function renderLoc(){const s=document.getElementById('loc_select');s.innerHTML="";locs.forEach((l,i)=>{let o=document.createElement('option');o.value=i;o.innerText=l.name;s.appendChild(o);});locChange();}
    function locChange(){const has=(locs.length>0);document.getElementById('btn_edit').disabled=!has;document.getElementById('btn_del').disabled=!has;}
    function modal(m){document.getElementById('loc_modal').style.display='block';if(m==='loc_edit'){editIdx=document.getElementById('loc_select').value;document.getElementById('m_title').innerText="ç·¨é›†";document.getElementById('m_name').value=locs[editIdx].name;document.getElementById('m_addr').value=locs[editIdx].addr;}else{editIdx=-1;document.getElementById('m_title').innerText="æ–°è¦";document.getElementById('m_name').value="";document.getElementById('m_addr').value="";}}
    function saveLoc(){const n=document.getElementById('m_name').value,a=document.getElementById('m_addr').value;if(n){if(editIdx>=0)locs[editIdx]={name:n,addr:a};else locs.push({name:n,addr:a});localStorage.setItem('gym_locs_v14',JSON.stringify(locs));renderLoc();document.getElementById('loc_modal').style.display='none';}}
    function delLoc(){if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){locs.splice(document.getElementById('loc_select').value,1);localStorage.setItem('gym_locs_v14',JSON.stringify(locs));renderLoc();}}
    function getData(){const inputs=document.querySelectorAll('input,select,textarea');const d={};inputs.forEach(e=>{if(e.id && !e.id.startsWith('m_') && e.id!=='prompt_output' && !e.id.startsWith('res_') && !e.id.startsWith('diff_')) d[e.id]=e.value;});return d;}
    function restoreData(d){Object.keys(d).forEach(k=>{const e=document.getElementById(k);if(e)e.value=d[k];});calc(); initAutoResize();}
    function saveToHistory(){const d=getData(); const now=new Date();const item={id:now.getTime(), date:document.getElementById('date_input').value, time:now.toLocaleTimeString(),loc:locs[document.getElementById('loc_select').value]?.name||"Unknown",imp:(document.getElementById('impression').value||"").substring(0,20), data:d};let h=JSON.parse(localStorage.getItem('gym_hist_v14')||"[]");h.unshift(item);localStorage.setItem('gym_hist_v14',JSON.stringify(h));localStorage.setItem('gym_autosave_v14',JSON.stringify(d));alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");}
    function openHistory(){const h=JSON.parse(localStorage.getItem('gym_hist_v14')||"[]");const el=document.getElementById('history_list'); el.innerHTML="";if(h.length===0) el.innerHTML="<li style='padding:10px;'>å±¥æ­´ãªã—</li>";else h.forEach((item,i)=>{const li=document.createElement('li'); li.className="history-item";li.innerHTML=`<div class="history-info" onclick="loadHist(${i})"><div class="history-date">${item.date} (${item.time})</div><div class="history-meta">ğŸ“${item.loc} / ğŸ“${item.imp}...</div></div><button class="history-del" onclick="delHist(${i})">å‰Šé™¤</button>`;el.appendChild(li);});document.getElementById('history_modal').style.display='block';}
    function loadHist(i){if(confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")){const h=JSON.parse(localStorage.getItem('gym_hist_v14')||"[]");if(h[i]) restoreData(h[i].data);document.getElementById('history_modal').style.display='none';}}
    function delHist(i){if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){let h=JSON.parse(localStorage.getItem('gym_hist_v14')||"[]");h.splice(i,1); localStorage.setItem('gym_hist_v14',JSON.stringify(h));openHistory();}}
    function openDataMgr(){ document.getElementById('data_modal').style.display='block'; }
    function exportData(){const backup = {locs: localStorage.getItem('gym_locs_v14'),history: localStorage.getItem('gym_hist_v14'),autosave: localStorage.getItem('gym_autosave_v14')};const blob = new Blob([JSON.stringify(backup)], {type: 'application/json'});const url = URL.createObjectURL(blob);const a = document.createElement('a');const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');a.href = url; a.download = `gymkhana_v14_backup_${dateStr}.json`;document.body.appendChild(a); a.click(); document.body.removeChild(a);alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");}
    function importData(input){const file = input.files[0]; if(!file) return;const reader = new FileReader();reader.onload = (e) => {try {const data = JSON.parse(e.target.result);if(confirm("ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")){if(data.locs) localStorage.setItem('gym_locs_v14', data.locs);if(data.history) localStorage.setItem('gym_hist_v14', data.history);if(data.autosave) localStorage.setItem('gym_autosave_v14', data.autosave);alert("å¾©å…ƒå®Œäº†ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"); location.reload();}} catch(err) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼"); }};reader.readAsText(file);}
    function resetAllData(){if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){localStorage.removeItem('gym_locs_v14');localStorage.removeItem('gym_hist_v14');localStorage.removeItem('gym_autosave_v14');alert("åˆæœŸåŒ–å®Œäº†"); location.reload();}}

    window.onload = init;
</script>

</body>
</html>